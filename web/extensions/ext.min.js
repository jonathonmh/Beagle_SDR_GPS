

/* web/extensions/ext.min.js */
var extint={ws:null,extname:null,param:null,override_pb:!1,displayed:!1,help_displayed:!1,current_ext_name:null,using_data_container:!1,default_w:525,default_h:300,prev_mode:null,seq:0,no_lockout:["noise_blank","noise_filter","ant_switch","iframe","colormap","devl"]},devl={in1:1,in2:0,in3:0};function ext_switch_to_client(e,t,n){recv_websocket(extint.ws,n),ext_send("SET ext_switch_to_client="+e+" first_time="+(t?1:0)+" rx_chan="+rx_chan),w3_call(e+"_focus")}function ext_send(e,t){null==t&&(t=extint.ws);try{return t.send(e),0}catch(e){console.log("CATCH ext_send('"+s+"') ex="+e),kiwi_trace()}}function ext_panel_show(e,t,n){extint_panel_show(e,t,n)}function ext_set_data_height(e){var t=w3_el("id-ext-data-container");e?t&&(t.style.height=px(e)):t&&(t.style.height="")}function ext_set_controls_width_height(e,t){panel_set_width_height("ext-controls",e,t)}var EXT_SAVE=!0,EXT_NO_SAVE=!1;function ext_get_cfg_param(e,t,n){var _;e=w3_add_toplevel(e);try{_=getVarFromString(e)}catch(e){_=null}return null!=_&&null!=_||null==t||(_=t,setVarFromString(e,_),null!=n&&n!=EXT_SAVE||cfg_save_json(e,extint.ws)),_}function ext_get_cfg_param_string(e,t,n){return decodeURIComponent(ext_get_cfg_param(e,t,n))}function ext_set_cfg_param(e,t,n){e=w3_add_toplevel(e),setVarFromString(e,t),null!=n&&n==EXT_SAVE&&cfg_save_json(e,extint.ws)}function ext_get_freq_range(){var e=cfg.freq_offset;return{lo_kHz:cfg.sdr_hu_lo_kHz+e,hi_kHz:cfg.sdr_hu_hi_kHz+e,offset_kHz:e}}var extint_isAdmin_cb,extint_authkey_cb,ext_zoom={TO_BAND:0,IN:1,OUT:-1,ABS:2,WHEEL:3,NOM_IN:8,MAX_IN:9,MAX_OUT:-9},extint_ext_is_tuning=!1;function ext_tune(e,t,n,_,i,o){var a=null!=i&&null!=o;extint_ext_is_tuning=!0,freqmode_set_dsp_kHz(e,t),a&&ext_set_passband(i,o),null!=n?zoom_step(n,_):zoom_step(ext_zoom.TO_BAND),extint_ext_is_tuning=!1}function ext_get_freq_Hz(){return{displayed:freq_displayed_Hz,carrier:freq_car_Hz,passband_center:freq_passband_center()}}function ext_get_freq(){return freq_displayed_Hz}function ext_get_freq_kHz(){return(freq_displayed_Hz/1e3).toFixed(2)}function ext_get_carrier_freq(){return freq_car_Hz}function ext_get_passband_center_freq(){return freq_passband_center()}function ext_get_mode(){return cur_mode}function ext_is_IQ_or_stereo_mode(){return"drm"==cur_mode||"iq"==cur_mode||"sas"==cur_mode}function ext_get_prev_mode(){return extint.prev_mode}function ext_set_mode(e,t,n){var _="drm"==e;_&&(extint.prev_mode=cur_mode),demodulator_analog_replace(e,t);var i=w3_opt(n,"open_ext",!1),o=w3_opt(n,"no_drm_proc",!1),a="undefined"!=typeof drm&&drm.active;console.log("$ new_drm="+_+" open_ext="+i),o||(_&&i?a?toggle_panel("ext-controls",1):extint_open("drm"):!_&&a&&(extint_panel_hide(),demodulator_analog_replace(e,t)))}function ext_get_passband(){var e=demodulators[0];return{low:e.low_cut,high:e.high_cut}}function ext_set_passband(e,t,n,_){var i=demodulators[0],o=i.filter;null==e&&(e=i.low_cut),null==t&&(t=i.high_cut);Math.abs(t-e);e=e<o.low_cut_limit?o.low_cut_limit:e,t=t>o.high_cut_limit?o.high_cut_limit:t;var a=!1;Math.abs(t-e)>=o.min_passband&&e<t&&(i.low_cut=e,i.high_cut=t,a=!0),isArg(n)&&n&&a&&(passbands[cur_mode].last_lo=e,passbands[cur_mode].last_hi=t),null!=_&&null!=_&&(_*=1e3,freq_car_Hz=freq_dsp_to_car(_)),extint_ext_is_tuning=!0,demodulator_set_offset_frequency(0,freq_car_Hz-center_freq),extint_ext_is_tuning=!1}function ext_get_tuning(){return{low:demod.low_cut,high:demod.high_cut,mode:cur_mode,freq_dial_kHz:freq_displayed_Hz/1e3}}function ext_get_zoom(){return zoom_level}function ext_get_optbar(){return readCookie("last_optbar")}function ext_set_optbar(e){extint.optbars[e]&&(writeCookie("last_optbar",e),w3_el("id-nav-"+e).click())}function ext_hasCredential(e,t,n,_){var i;"mfg"==e&&(e="admin"),"admin"==e?(deleteCookie("admin"),deleteCookie("admin-pwd"),i=""):i=(i=readCookie(e))?decodeURIComponent(i):"",extint_pwd_cb=t,extint_pwd_cb_param=n,ext_valpwd(e,i,_)}function ext_valpwd(e,t,n){t=encodeURIComponent(t),"admin"!=e&&writeCookie(e,t),extint_conn_type=e,t=""!=t?t:"#";var _=null,i=readCookie("iplimit"),o=kiwi_url_param(["pwd","password"],"","");""!=o?_=o:i&&""!=i&&(_=i),_=_?" ipl="+_:"",null!=kiwi_url_param(["p","prot","protected"],"true",null)&&"admin"!=e&&(e="prot"),ext_send("SET auth t="+e+" p="+t+_,n)}function ext_isAdmin(e){extint_isAdmin_cb=e,ext_send("SET is_admin")}function ext_get_authkey(e){ext_send("SET get_authkey"),extint_authkey_cb=e}extint.optbars={"optbar-wf":0,"optbar-audio":1,"optbar-agc":2,"optbar-users":3,"optbar-status":4,"optbar-off":5};var extint_adc_clock_Hz=0;function ext_adc_clock_Hz(){return extint_adc_clock_Hz}var extint_adc_gps_clock_corr=0;function ext_adc_gps_clock_corr(){return extint_adc_gps_clock_corr}var extint_adc_clock_nom_Hz=0;function ext_adc_clock_nom_Hz(){return extint_adc_clock_nom_Hz}var extint_srate=0;function ext_sample_rate(){return extint_srate}var extint_audio_data_cb=null;function ext_register_audio_data_cb(e){extint_audio_data_cb=e}function ext_unregister_audio_data_cb(){extint_audio_data_cb=null}function ext_param(){var e=extint.param;return extint.param=null,e}function ext_panel_set_name(e){extint.current_ext_name=e}function ext_mobile_info(e){var t=window.innerWidth,n=window.innerHeight,_={width:t,height:n};_.wh_unchanged=e&&e.width==t&&e.height==n?1:0;var i=t<n||mobile_laptop_test?1:0;return _.orient_unchanged=e&&e.isPortrait==i?1:0,_.isPortrait=i?1:0,_.iPad=i&&t<=768?1:0,_.small=i&&t<768?1:0,_.narrow=i&&n<=600?1:0,_}function extint_news(e){var t=w3_el("id-news");t.style.width="400px",t.style.height="300px",t.style.visibility="visible",t.style.zIndex=9999,w3_innerHTML("id-news-inner",e)}function ext_panel_init(){w3_el("id-panels-container").innerHTML+='<div id="id-ext-controls" class="class-panel" data-panel-name="ext-controls" data-panel-pos="bottom-left" data-panel-order="0" data-panel-size="'+extint.default_w+","+extint.default_h+'"></div>';var e=w3_el("id-ext-data-container");e.style.zIndex=100,(e=w3_el("id-ext-controls")).innerHTML=w3_div("id-ext-controls-container w3-relative|width:100%;height:100%;")+w3_div("id-ext-controls-vis class-vis")+w3_div("id-ext-controls-help cl-ext-help",w3_button('id-ext-controls-help-btn w3-green w3-small w3-padding-small w3-disabled||onclick="extint_help_click()"',"help")),w3_el("id-kiwi-body").addEventListener("keyup",function(e){"Escape"==e.key&&extint.displayed&&!confirmation.displayed&&w3_el("id-ext-controls-close").click()},!0)}function extint_panel_show(e,t,n){var _;extint.using_data_container=!!t,extint.using_data_container?(toggle_or_set_spec(toggle_e.SET,0),w3_hide("id-top-container"),w3_show_block(w3_innerHTML("id-ext-data-container",t))):(w3_hide("id-ext-data-container"),spectrum_display||w3_show_block("id-top-container")),1==extint.help_displayed&&(confirmation_panel_close(),extint.help_displayed=!1),(_=w3_el("id-ext-controls-close")).onclick=function(){toggle_panel("ext-controls"),extint_panel_hide()},w3_el("id-ext-controls").style.zIndex=150,w3_attribute("id-ext-controls-close-img","src","icons/close.24.png"),(_=w3_el("id-ext-controls-container")).innerHTML=e,n&&n(),(_=w3_el("id-ext-controls")).style.zIndex=150,w3_visible(_,!0),_.panelShown=1,toggle_or_set_hide_panels(0),w3_el("id-confirmation-container").style.height="";var i=w3_call(extint.current_ext_name+"_help",!1);w3_set_props("id-ext-controls-help-btn","w3-disabled",isUndefined(i)||0==i),"off"==i&&w3_hide("id-ext-controls-help-btn"),extint.displayed=!0}function ext_panel_displayed(e){return extint.displayed&&(!e||e==extint.current_ext_name)}function ext_panel_redisplay(e){w3_innerHTML("id-ext-controls-container",e)}function extint_panel_hide(){extint.using_data_container&&(w3_hide("id-ext-data-container"),w3_show_block("id-top-container"),extint.using_data_container=!1,1==extint.help_displayed&&(confirmation_panel_close(),extint.help_displayed=!1)),w3_visible("id-ext-controls",!1),extint_blur_prev(1),w3_select_value("select-ext",-1),resize_waterfall_container(!0),freqset_select(),extint.displayed=!1}function extint_help_click(){w3_contains("id-ext-controls-help-btn","w3-disabled")||(console.log(extint.current_ext_name+"_help_click CLICKED"),extint.help_displayed=w3_call(extint.current_ext_name+"_help",!0))}function extint_environment_changed(e){setTimeout(function(){extint.current_ext_name&&w3_call(extint.current_ext_name+"_environment_changed",e),w3_call("injection_environment_changed",e)},100)}var extint_pwd_cb=null,extint_pwd_cb_param=null,extint_conn_type=null;function extint_valpwd_cb(e){extint_pwd_cb&&extint_pwd_cb(e,extint_pwd_cb_param)}function extint_open_ws_cb(){ext_hasCredential("kiwi",null,null),setTimeout(function(){setInterval(function(){ext_send("SET keepalive")},5e3)},5e3)}function extint_connect_server(){return extint.ws=open_websocket("EXT",extint_open_ws_cb,null,extint_msg_cb),extint.ws}function extint_msg_cb(e,t){switch(e[0]){case"keepalive":break;case"ext_client_init":console.log("ext_client_init is_locked="+ +e[1]),extint_focus(+e[1]);break;default:return!1}return!0}function extint_blur_prev(e){null!=extint.current_ext_name&&(w3_call(extint.current_ext_name+"_blur"),recv_websocket(extint.ws,null),e&&ext_set_controls_width_height(),extint.current_ext_name=null,time_display_setup("id-topbar-right-container")),extint.ws&&ext_send("SET ext_blur="+rx_chan)}function extint_focus(e){var t=extint.current_ext_name;if(console.log("extint_focus: loading "+t+".js"),e&&!extint.no_lockout.includes(t))return extint_panel_show(w3_text("w3-medium w3-text-css-yellow","Cannot use extensions while <br> another channel is in DRM mode.")),void ext_set_controls_width_height(450,75);kiwi_load_js_dir("extensions/"+t+"/"+t,[".js",".css"],function(){console.log("extint_focus: calling "+t+"_main()"),ext_set_controls_width_height(),w3_call(t+"_main")},function(e){if(console.log("extint_focus: "+t+" loaded="+e),e){extint_panel_show("loading extension..."),ext_set_controls_width_height(325,45),kiwi.is_locked&&console.log("==== IS_LOCKED =================================================")}})}var extint_names,extint_first_ext_load=!0;function extint_select(e){extint_blur_prev(0),e=+e,w3_el("select-ext").value=e,extint.current_ext_name=extint_names[e],extint_first_ext_load?(extint.ws=extint_connect_server(),extint_first_ext_load=!1):ext_send("SET ext_is_locked_status")}function extint_list_json(e){extint_names=JSON.parse(decodeURIComponent(e))}function extint_select_menu(){var e="";if(extint_names&&isArray(extint_names))for(var t=0;t<extint_names.length;t++){var n=extint_names[t];if((dbgUs||"sig_gen"!=n)&&((dbgUs||"devl"!=n)&&(dbgUs||"s4285"!=n)&&(dbgUs||"colormap"!=n))){"wspr"==n&&(n="WSPR");var _=ext_get_cfg_param(n+".enable");(null==_||kiwi.is_local[rx_chan])&&(_=!0),"DRM"==n&&(kiwi.DRM_enable=_),e+='<option value="'+t+'" '+(_?"":"disabled")+">"+n+"</option>"}}return e}function extint_open(e,t){e=e.toLowerCase();for(var n=0;n<extint_names.length;n++){var _=extint_names[n];"wspr"==_&&(_="WSPR");var i=ext_get_cfg_param(_+".enable");if((null==i||kiwi.is_local[rx_chan])&&(i=!0),i&&_.toLowerCase().includes(e)){t?setTimeout(function(){extint_select(n)},t):extint_select(n);break}}}function extint_audio_data(e,t){isFunction(extint_audio_data_cb)&&extint_audio_data_cb(e,t)}